<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0">
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="./styles/style.css">
    <link href="./styles/fa/css/fontawesome.css" rel="stylesheet">
    <link href="./styles/fa/css/brands.css" rel="stylesheet">
    <link href="./styles/fa/css/solid.css" rel="stylesheet">
    <link rel="stylesheet" href="./styles/line.css">
    <title>Dash</title>
</head>

<body>
    <div class="title-bar">
        <div class="head">
            <div class="head-title">Dash <span id="project-name"></span></div>
        </div>
        <div class="window-icons">
            <div class="window-icon" id="close-window-icon">
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
    </div>
    <div class="container" id="panels-container">

        <div id="home-view">
            <div style="text-decoration: underline;">
                <b>No</b> file is opened
            </div>
            <div>
                <b><i>Ctrl+b</i></b> : toggle the TreeView
            </div>
            <div>
                <b><i>Ctrl+o</i></b> : toggle the quick file search
            </div>
            <div style="text-decoration: underline;">
                or
            </div>
            <div>
                <button class="btn">
                    Browse files
                </button>
            </div>
        </div>
    </div>

    <div class="footer">
        <!-- TODO : Remove project path from this bar, put it into the window title & put the icons aligned to the left -->
        <div class="color-white">
            <span class="taskbar-item">
                <i class="fa-regular fa-folder-open"></i> Browse a new project
            </span>
            <span class="taskbar-item">
                <i class="fa-solid fa-question"></i> Help
            </span>
            <span class="taskbar-item">
                <i class="fa-solid fa-gears"></i> Settings
            </span>
            <span class="taskbar-item">
                <i class="fa-solid fa-code-branch"></i> <span id="branch-name">master</span>
            </span>
        </div>
        <div class="color-white">
            May 2nd, 14:32
        </div>
    </div>
    <div id="modals-container">
        <div id="open-project-modal" class="modal">
            <div class="modal-header">
                Open Project or file
            </div>
            <div class="modal-body" id="open-project-body">
                <div id="open-project">
                    <button class="btn" onclick="window.electronAPI.openProject()">Open project <i
                            class="fa-solid fa-folder-open"></i></button>
                </div>
                <div id="open-file">
                    <button class="btn" onclick="window.electronAPI.toggleOpenFile()">Open file <i
                            class="fa-solid fa-file"></i></button>
                </div>
                <div id="new-file">
                    <button class="btn" onclick="EditorsManager.openNewFile()">New file <i
                            class="fa-solid fa-plus"></i></button>
                </div>
            </div>
        </div>
        <div id="tree-modal" class="modal">
            <div class="modal-header" id="tree-modal-title">
            </div>
            <div class="modal-body">
                <div id="search-file">
                    <input type="text" id="tree-search-file" placeholder="Search file">
                    <div>
                        <i class="fa-solid fa-folder-plus"></i>
                    </div>
                    <div>
                        <i class="fa-solid fa-file-circle-plus"></i>
                    </div>
                </div>
                <div id="project-tree">

                </div>
            </div>
        </div>
        <div id="quick-file-search-modal" class="modal">
            <div class="modal-header" id="tree-modal-title">
                Open file (press shift for new panel)
            </div>
            <div class="modal-body">
                <div id="quick-search-file">
                    <input type="text" id="quick-search-file-input" onkeyup="" placeholder="Search file">
                </div>
                <div id="quick-search-file-results">

                </div>
            </div>
        </div>
    </div>
    <script src="./public/highlight/highlight.min.js"></script>
    <script src="./public/IPCManager.js"></script>
    <script src="./public/Line.js"></script>
    <script src="./public/Lines.js"></script>
    <script src="./public/EditorTab.js"></script>
    <script src="./public/TextDisplay.js"></script>
    <script src="./public/TextEditor.js"></script>
    <script src="./public/Editor.js"></script>
    <script src="./public/EditorsManager.js"></script>
    <script src="./public/ModalsManager.js"></script>
    <script src="./public/Directory.js"></script>
    <script src="./public/File.js"></script>
    <script src="./public/Tree.js"></script>
    <script src="./public/Panel.js"></script>
    <script src="./public/Panels.js"></script>
    <script src="./public/renderer.js"></script>
    <script>
        document.addEventListener('keydown', (event) => {
            if (event.ctrlKey && event.key == 'b') {
                ModalsManager.toggleTreeModal()
            }
            if (event.ctrlKey && event.key == 'o') {
                ModalsManager.toggleQuickSearchModal()
            }
            if (event.ctrlKey && event.shiftKey && event.key == 'O') {
                ModalsManager.toggleQuickSearchModal()
            }
            if (event.key == 'Escape') {
                ModalsManager.hideModals()
            }
        })

        document.getElementById('tree-search-file').addEventListener('keyup', (event) => {
            Tree.search(event.target.value)
        })

        let selectedQuickSearchResultItem = null
        let limitQuickSearchResultItem
        let matches = []
        document.getElementById('quick-search-file-input').addEventListener('keydown', (event) => {
            if (event.key == 'ArrowDown' || event.key == 'ArrowUp') {
                event.preventDefault()
            }
        })
        document.getElementById('quick-search-file-input').addEventListener('keyup', (event) => {
            if (event.key == 'Enter') {
                // Open the selected file
                if (event.shiftKey) {
                    // Open in a new panel
                    let file = matches[selectedQuickSearchResultItem]
                    window.electronAPI.openFile(`${file.path}/${file.name}`).then((data) => {
                        EditorsManager.openFileInNewPanel({
                            name: data.fileName,
                            content: data.fileContent,
                            path: data.filePath
                        })
                        ModalsManager.hideModals()
                        // ModalsManager.hideTreeModal()
                    })
                } else {
                    // Open in the current panel
                    let file = matches[selectedQuickSearchResultItem]
                    window.electronAPI.openFile(`${file.path}/${file.name}`).then((data) => {
                        EditorsManager.openFile({
                            name: data.fileName,
                            content: data.fileContent,
                            path: data.filePath
                        })
                        ModalsManager.hideModals()
                        // ModalsManager.hideTreeModal()
                    })
                }
                selectedQuickSearchResultItem = null
                limitQuickSearchResultItem = undefined
                matches = []
                document.getElementById('quick-search-file-input').value = ''
                document.getElementById('quick-search-file-results').innerHTML = ''
            } else if (event.key == 'ArrowDown') {
                event.preventDefault()
                // Move down the selected
                if (selectedQuickSearchResultItem < limitQuickSearchResultItem - 1) {
                    document.querySelectorAll('.quick-file-search-item')[selectedQuickSearchResultItem].classList.remove('active')
                    selectedQuickSearchResultItem++
                    document.querySelectorAll('.quick-file-search-item')[selectedQuickSearchResultItem].classList.add('active')
                }
            } else if (event.key == 'ArrowUp') {
                event.preventDefault()
                // Move up the selected
                if (selectedQuickSearchResultItem > 0) {
                    document.querySelectorAll('.quick-file-search-item')[selectedQuickSearchResultItem].classList.remove('active')
                    selectedQuickSearchResultItem--
                    document.querySelectorAll('.quick-file-search-item')[selectedQuickSearchResultItem].classList.add('active')
                }

            } else if (event.target.value.length > 0) {
                matches = ModalsManager.quickSearch(Tree.getInstance().root, event.target.value)
                if (matches.length > 0) {
                    ModalsManager.buildQuickSearchResult(matches)
                    selectedQuickSearchResultItem = 0
                    document.querySelectorAll('.quick-file-search-item')[selectedQuickSearchResultItem].classList.add('active')
                    limitQuickSearchResultItem = matches.length
                }
                // Set the active result as first of the list (active class with background color)

            } else {
                document.getElementById('quick-search-file-results').innerHTML = ''
            }
        })
    </script>
</body>

</html>